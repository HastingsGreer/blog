<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="https://apj.hgreer.com/blog"> <link rel=icon  href="/assets/favicon.png"> <script> fetch("https://apj.hgreer.com/referrer?" + document.referrer); </script> <title>Writing scientific code with the minimum of abstraction</title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <!-- <li><a href="/FeatureMapICON/">Feature Map Inverse Consistency</a> --> <li><a href="/HatTile/">Aperiodic Tiling with Z3</a> <!-- <li><a href="/ICON/">Inverse Consistent Regstration</a> <li><a href="/Mandelbrot/">Mandelbrot Set Adventures</a> --> <li><a href="/JavascriptMandelbrot/">Mandelbrot Set</a> <li><a href="/TrebuchetSimulator/">Trebuchet Simulator</a> <li><a href="/BadMatrixMultiply/">Bad Matrix Multiplication</a> <li><a href="/GameJam/">Game Jam Games</a> <li><a href="/menu3/">Tags</a> </ul> </div> <div id=main > <div class=franklin-content ><h1 id=how_to_write_better_scientific_code_while_fighting_boilerplate ><a href="#how_to_write_better_scientific_code_while_fighting_boilerplate" class=header-anchor >How to write better scientific code while fighting boilerplate</a></h1> <p>This post is a response to the article <a href="https://zerowithdot.com/improve-data-science-code/">How to write better scientific code in Python</a> and the ensuing <a href="https://news.ycombinator.com/item?id&#61;30397485">Hacker News discussion</a>. I think that that article suffered from using a toy example, and so I am writing a similarly structured article using a real example.</p> <h2 id=the_task ><a href="#the_task" class=header-anchor >The task</a></h2> <p>While writing my paper <a href="https://arxiv.org/abs/2105.04459">ICON: Learning regular maps through inverse consistency</a> I ran into a problem familiar to any object oriented data scientist: I needed to represent a mathematical object as a python object in a flexible way, without my code ballooning in type complexity or becoming too rigid to experiment on. In my case, the mathematical object was a geometric transformation: a function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant=normal >Φ</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>:</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup><mo>→</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex"> \Phi^{-1} : \mathbb{R}^N \rightarrow \mathbb{R}^N </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class=mord >Φ</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8413309999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8413309999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span> which represents how to move each pixel in an image to warp it. </p> <p>There are a variety of different types of transforms, such as translations, rotations, and arbitrary warpings which specify where each individual pixel in the resulting image </p> <p>There are several operations we want to implement for all our transform objects: we want to we want to be able to warp an image using a transform, we want to transform a point, and we want to be able to compose two transforms. There are some transforms we can invert.</p> <p>Ultimately this is a neural network project, and what will happen is a neural network will output a batch of transforms, which will have some loss computed on it.</p> <h2 id=before_and_after ><a href="#before_and_after" class=header-anchor >Before and After</a></h2> <p>Before:</p> <h2 id=bad_code_the_starting_point ><a href="#bad_code_the_starting_point" class=header-anchor >&#39;Bad&#39; code: the starting point</a></h2> <p>My initial &#39;Bad&#39; code implemented two kinds of geometric transform: linear transforms, and arbitrary warps. </p> <h3 id=affine_transforms ><a href="#affine_transforms" class=header-anchor >Affine Transforms</a></h3> <p>The correct way to represent an affine transform comes carved in stone from the mathematicians: This should be an N &#43; 1 x N &#43; 1 matrix. &#40;A batch of N &#43; 1 x N &#43; 1 matrices&#41;</p> <p>If pressed I could write a function for composing two linear transforms, I suspect anyone else would do it the same way:</p> <pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">compose_linear_transforms</span>(<span class=hljs-params >transform_A, transform_B</span>):
    <span class=hljs-keyword >return</span> transform_A @ transform_B</code></pre> <p>However, the &#39;bad&#39; programmer who doesn&#39;t really believe in types or abstraction would never do this. Why write <code>compose_linear_transforms&#40;x, y&#41;</code> when <code>x @ y</code> will do? Arguably, <code>@</code> <em>is</em> the function <code>compose_linear_transforms</code>. It is also the function <code>transform_point</code>. </p> <p>The function to warp an image using an affine map is slightly trickier. If we know the coordinates of each pixel in the input and output image, then it is well defined, and since we are bad programmers, lets just define the coordinates to range from -1 to 1 along each axis</p> <pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">warp_linear_transform</span>(<span class=hljs-params >transform, image</span>):</code></pre>
<h3 id=vector_field_transforms ><a href="#vector_field_transforms" class=header-anchor >Vector Field Transforms</a></h3>
<p>The other common form of geometric transform for a neural network </p>
<h1 id=detritus ><a href="#detritus" class=header-anchor >Detritus</a></h1>
<p>I work in the field of <a href="https://en.wikipedia.org/wiki/Image_registration">Image Registration</a> </p>


<div class=page-foot >
  <div>
    <a href=https://subdavis.com>subdavis.com </a> 
    <a href=http://forrestli.con>forrestli.com</a>
  <div class=copyright >
    &copy; Hastings Greer. Last modified: June 04, 2025. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
        </div> 
    </div>