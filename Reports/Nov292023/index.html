<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="https://apj.hgreer.com/blog"> <link rel=icon  href="/assets/favicon.png"> <title>scale equivariance</title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <!-- <li><a href="/FeatureMapICON/">Feature Map Inverse Consistency</a> --> <li><a href="/HatTile/">Aperiodic Tiling with Z3</a> <!-- <li><a href="/ICON/">Inverse Consistent Regstration</a> <li><a href="/Mandelbrot/">Mandelbrot Set Adventures</a> --> <li><a href="/JavascriptMandelbrot/">Mandelbrot Set</a> <li><a href="/TrebuchetSimulator/">Trebuchet Simulator</a> <li><a href="/BadMatrixMultiply/">Bad Matrix Multiplication</a> <li><a href="/GameJam/">Game Jam Games</a> <li><a href="/menu3/">Tags</a> </ul> </div> <div id=main > <div class=franklin-content ><h1 id=problem_no_scale_equivariance_in_real_lungs ><a href="#problem_no_scale_equivariance_in_real_lungs" class=header-anchor >Problem: No scale equivariance in real lungs</a></h1> <p>As a result, the transformer only captures translation</p> <p>just transformer:</p> <img src="/assets/Reports/Nov292023/code/transformerlung.png" alt=""> <p>overall pipeline:</p> <img src="/assets/Reports/Nov292023/code/totallung.png" alt=""> <p>The poor performance is coming from the entire non-translation transform being handled by the gradicon part.</p> <h1 id=tactic_create_a_2d_example_of_the_problem ><a href="#tactic_create_a_2d_example_of_the_problem" class=header-anchor >Tactic: Create a 2D example of the problem</a></h1> <p>We warp, shift, and also scale retina segmentations by 80&#37;. As a sanity check, we throw ConstrICON at this problem.</p> <p>Just 80&#37; scale, ConstrICON can do:</p> <img src="/assets/Reports/Nov292023/code/constriconshiftwin.png" alt=""> <p>However, with the scale and shift, ConstrICON cannot converge:</p> <img src="/assets/Reports/Nov292023/code/constriconshiftfail.png" alt=""> <p>Prediction: EquICON will capture the translation in the transformer, but will leave the scale to the displacement prediction layers, like we saw in the lung.</p> <p>Experiment Result:</p> <p>Our prediction was wrong. In 2d, the transformer layer captures the scale, only leaving local variations for the displacement layer. Therefore, we do not yet have a toy model.</p> <p>End to end result:</p> <p><img src="/assets/Reports/Nov292023/code/equiconretinascaleend2end.png" alt=""> </p> <p>Just Transformer:</p> <img src="/assets/Reports/Nov292023/code/equiconretinascaletransformer.png" alt=""> <h1 id=solutions ><a href="#solutions" class=header-anchor >Solutions:</a></h1> <p>I am hesitant to start trying solutions to the lung scale problem in 3d without a 2d model, but will do so if necessary.</p> <p>Once we can get a toy model, there are two solutions to test in 2d. Once is the magnitude penalty on the GradICON layers that we discussed earlier. As long as the GradICOn layers can capture the scale, then this penalty will shift it, once captured, onto the transformer layer.</p> <pre><code class="python hljs"><span class=hljs-keyword >return</span> (self.phi_AB, self.lmbda * inverse_consistency_loss 
   + torch.mean(<span class=hljs-number >10000</span> * (self.phi_AB(self.identity_map) - self.identity_map)**<span class=hljs-number >2</span>))</code></pre> <p>Does this work in the 2-D case?</p> <h1 id=solution_2_more_equivariance ><a href="#solution_2_more_equivariance" class=header-anchor >Solution 2: more equivariance.</a></h1> <p>The canonical way to get scale &quot;Equivariance&quot; is to run the image through the same network at multiple scales and sum &#40;citation citation&#41;. Does this help?</p> <h1 id=solution_3_the_3d_code_is_buggy ><a href="#solution_3_the_3d_code_is_buggy" class=header-anchor >Solution 3: The 3d code is buggy.</a></h1> <p>The way to fix this, if it&#39;s true, is to read the 3-D code until I see the bug? Hasn&#39;t worked so far.</p> <h1 id=marc_suggestions ><a href="#marc_suggestions" class=header-anchor >Marc suggestions: </a></h1> <p>Weaker 2d feature extraction</p> <p>Try retina using 3d code</p> <p>3D circles and squares</p> <p>White noise to 2d case</p> <p>Write up a MONAI integration timeline</p> <a href=/Reports/>Back to Reports</a> <div class=page-foot > <div> <a href=https://subdavis.com>subdavis.com </a> <a href=http://forrestli.con>forrestli.com</a> <div class=copyright > &copy; Hastings Greer. Last modified: July 05, 2024. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div>