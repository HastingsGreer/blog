<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="https://apj.hgreer.com/blog"> <link rel=icon  href="/assets/favicon.png"> <title>EquivariantTransformer</title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <!-- <li><a href="/FeatureMapICON/">Feature Map Inverse Consistency</a> --> <li><a href="/HatTile/">Aperiodic Tiling with Z3</a> <!-- <li><a href="/ICON/">Inverse Consistent Regstration</a> <li><a href="/Mandelbrot/">Mandelbrot Set Adventures</a> --> <li><a href="/JavascriptMandelbrot/">Mandelbrot Set</a> <li><a href="/TrebuchetSimulator/">Trebuchet Simulator</a> <li><a href="/BadMatrixMultiply/">Bad Matrix Multiplication</a> <li><a href="/GameJam/">Game Jam Games</a> <li><a href="/menu3/">Tags</a> </ul> </div> <div id=main > <div class=franklin-content ><p>In our toy problem, the images we want to register, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo separator=true >,</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A, B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">A</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, are diffeomorphisms.</p> <p>To register them, we want to find <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ξ</mi></mrow><annotation encoding="application/x-tex">\Xi</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ξ</span></span></span></span> such that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>∘</mo><mi mathvariant=normal >Ξ</mi><mo>=</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \circ \Xi = B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∘</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ξ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>.</p> <p>So, <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ξ</mi><mo>=</mo><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>∘</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">\Xi = A^{-1} \circ B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ξ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∘</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>.</p> <p>A neural network that can compute <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>∘</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A^{-1}\circ B</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∘</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> will have all the equivariances of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ξ</mi></mrow><annotation encoding="application/x-tex">\Xi</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ξ</span></span></span></span>.</p> <h1 id=transformers_naturally_implement_function_inversion ><a href="#transformers_naturally_implement_function_inversion" class=header-anchor >Transformers naturally implement function inversion</a></h1> <p>The Key, Query, Value attention mechanism naturally lends itself to implementing function inversion in a matter appropriate for representing <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ξ</mi></mrow><annotation encoding="application/x-tex">\Xi</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ξ</span></span></span></span>. As a first demo, we will invert the function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msup><mi>x</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">y=x^2</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8141079999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></p> <pre><code class="python hljs">x = torch.arange(<span class=hljs-number >0</span>, <span class=hljs-number >1</span>, <span class=hljs-number >1</span>/<span class=hljs-number >100</span>)
x = x[<span class=hljs-literal >None</span>, <span class=hljs-literal >None</span>, :]
y = x**<span class=hljs-number >2</span></code></pre> <p>First, we process our function inputs and outputs into feature vectors. These representations are chosen so that <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>e</mi><mi>p</mi><mi>r</mi><mo stretchy=false >(</mo><mi>u</mi><mo stretchy=false >)</mo><mo>⋅</mo><mi>r</mi><mi>e</mi><mi>p</mi><mi>r</mi><mo stretchy=false >(</mo><mi>v</mi><mo stretchy=false >)</mo><mo>≃</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">repr(u) \cdot repr(v) \simeq 1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mopen >(</span><span class="mord mathnormal">u</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >⋅</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">re</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class=mopen >(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≃</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span> when <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>≃</mo><mi>v</mi></mrow><annotation encoding="application/x-tex">u \simeq v</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.46375em;vertical-align:0em;"></span><span class="mord mathnormal">u</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >≃</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span>. </p> <pre><code class="python hljs">scale_weight = (torch.randn(<span class=hljs-number >100</span>) * <span class=hljs-number >59</span>)[:, <span class=hljs-literal >None</span>, <span class=hljs-literal >None</span>]

scale = torch.nn.Conv1d(<span class=hljs-number >1</span>, <span class=hljs-number >100</span>, <span class=hljs-number >1</span>, bias=<span class=hljs-literal >True</span>)

<span class=hljs-keyword >with</span> torch.no_grad():
    scale.weight[:] = scale_weight
ft_x = torch.sin(scale(x))
ft_y = torch.sin(scale(y))</code></pre> <pre><code class="python hljs">plt.imshow(ft_x[<span class=hljs-number >0</span>])
plt.imshow(ft_y[<span class=hljs-number >0</span>])</code></pre> <p><img src="/assets/Reports/Sep142023/code/ft_x.png" alt=""> <img src="/assets/Reports/Sep142023/code/ft_y.png" alt=""></p> <p>Then, do an attention, with function outputs as Keys, function inputs as Values, and the values that we want to pass to the inverted function as Queries.</p> <pre><code class="python hljs">attention = torch.nn.functional.softmax((ft_x.permute(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>, <span class=hljs-number >1</span>) @ ft_y), dim=<span class=hljs-number >2</span>)
                                       
plt.imshow(attention.detach()[<span class=hljs-number >0</span>])</code></pre> <img src="/assets/Reports/Sep142023/code/attention.png" alt=""> <pre><code class="python hljs">output = attention @ x.permute(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>, <span class=hljs-number >1</span>)
plt.plot(output[<span class=hljs-number >0</span>].detach())</code></pre> <img src="/assets/Reports/Sep142023/code/output.png" alt=""> <p>Voila, the graph of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>x</mi></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{x}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.04em;vertical-align:-0.23972em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8002800000000001em;"><span class=svg-align  style="top:-3em;"><span class=pstrut  style="height:3em;"></span><span class=mord  style="padding-left:0.833em;"><span class="mord mathnormal">x</span></span></span><span style="top:-2.76028em;"><span class=pstrut  style="height:3em;"></span><span class=hide-tail  style="min-width:0.853em;height:1.08em;"><svg width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z'/></svg></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.23972em;"><span></span></span></span></span></span></span></span></span>.</p> <h1 id=registering_two_images_using_a_neural_network ><a href="#registering_two_images_using_a_neural_network" class=header-anchor >Registering two images using a neural network</a></h1> <p>We define some &#40;1-D&#41; images to register:</p> <p>Image A is <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>:</mo><mo stretchy=false >[</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo>→</mo><mo stretchy=false >[</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo separator=true >,</mo><mi>x</mi><mo>↦</mo><mi>cos</mi><mo>⁡</mo><mo stretchy=false >(</mo><mfrac><mi>π</mi><mn>2</mn></mfrac><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">A: [0, 1] \rightarrow[0, 1], x \mapsto \cos(\frac{\pi}{2} x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >↦</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.095em;vertical-align:-0.345em;"></span><span class=mop >cos</span><span class=mopen >(</span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class=pstrut  style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span></p> <p>Image B is <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>:</mo><mo stretchy=false >[</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo>→</mo><mo stretchy=false >[</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo separator=true >,</mo><mi>x</mi><mo>↦</mo><mi>x</mi><mo>+</mo><mn>0.07</mn><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>3</mn><mi>π</mi><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">B: [0, 1] \rightarrow[0, 1], x \mapsto x + 0.07 \sin(3\pi x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >↦</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >0.07</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class=mord >3</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span></p> <pre><code class="python hljs">A = torch.cos(<span class=hljs-number >.5</span> * torch.pi * x)
B = x + <span class=hljs-number >.07</span> * torch.sin(<span class=hljs-number >3</span> * torch.pi * x)

plt.plot(A[<span class=hljs-number >0</span>, <span class=hljs-number >0</span>])
plt.plot(B[<span class=hljs-number >0</span>, <span class=hljs-number >0</span>])</code></pre> <img src="/assets/Reports/Sep142023/code/AandB.png" alt=""> <p>We know analytically that A and B are registered by </p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=normal >Ξ</mi><mo stretchy=false >[</mo><mi>A</mi><mo separator=true >,</mo><mi>B</mi><mo stretchy=false >]</mo><mo>=</mo><msup><mi>A</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>∘</mo><mi>B</mi><mo>=</mo><mfrac><mn>2</mn><mi>π</mi></mfrac><msup><mrow><mi>cos</mi><mo>⁡</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy=false >(</mo><mi>x</mi><mo>+</mo><mn>0.07</mn><mi>sin</mi><mo>⁡</mo><mo stretchy=false >(</mo><mn>3</mn><mi>π</mi><mi>x</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">\Xi[A, B] = A^{-1} \circ B = \frac{2}{\pi} \cos^{-1}(x + 0.07 \sin(3\pi x))</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >Ξ</span><span class=mopen >[</span><span class="mord mathnormal">A</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.864108em;vertical-align:0em;"></span><span class=mord ><span class="mord mathnormal">A</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >∘</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:2.00744em;vertical-align:-0.686em;"></span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.32144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord >2</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop ><span class=mop >cos</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >+</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mord >0.07</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mop >sin</span><span class=mopen >(</span><span class=mord >3</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mord mathnormal">x</span><span class=mclose >))</span></span></span></span></span> <p>We create a neural network that inverts A and applies the result to B, and verify that our neural network correctly implements <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant=normal >Ξ</mi></mrow><annotation encoding="application/x-tex">\Xi</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Ξ</span></span></span></span> on this specific example.</p> <pre><code class="python hljs"><span class=hljs-keyword >class</span> <span class="hljs-title class_">AttentionRegistration</span>(torch.nn.Module):
    <span class=hljs-keyword >def</span> <span class="hljs-title function_">__init__</span>(<span class=hljs-params >self</span>):
        <span class="hljs-variable language_">self</span>.x = torch.arange(<span class=hljs-number >0</span>, <span class=hljs-number >1</span>, <span class=hljs-number >1</span>/<span class=hljs-number >100</span>)
        <span class="hljs-variable language_">self</span>.x = <span class="hljs-variable language_">self</span>.x[<span class=hljs-literal >None</span>, <span class=hljs-literal >None</span>, :]
        
        scale_weight = (torch.randn(<span class=hljs-number >100</span>) * <span class=hljs-number >59</span>)[:, <span class=hljs-literal >None</span>, <span class=hljs-literal >None</span>]

        <span class="hljs-variable language_">self</span>.scale = torch.nn.Conv1d(<span class=hljs-number >1</span>, <span class=hljs-number >100</span>, <span class=hljs-number >1</span>, bias=<span class=hljs-literal >True</span>)

        <span class=hljs-keyword >with</span> torch.no_grad():
            <span class="hljs-variable language_">self</span>.scale.weight[:] = scale_weight
    
    <span class=hljs-keyword >def</span> <span class="hljs-title function_">featurize</span>(<span class=hljs-params >values</span>):
        values = <span class="hljs-variable language_">self</span>.scale(values)
        <span class=hljs-keyword >return</span> torch.sin(values)
    
    <span class=hljs-keyword >def</span> <span class="hljs-title function_">forward</span>(<span class=hljs-params >A, B</span>):
        ft_A = <span class="hljs-variable language_">self</span>.featurize(A)
        ft_B = <span class="hljs-variable language_">self</span>.featurize(B)
        
        attention = torch.nn.functional.softmax((ft_B.permute(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>, <span class=hljs-number >1</span>) @ ft_A), dim=<span class=hljs-number >2</span>)
        
        output = attention @ x.permute(<span class=hljs-number >0</span>, <span class=hljs-number >2</span>, <span class=hljs-number >1</span>)
        
        <span class=hljs-keyword >return</span> output
ar = AttentionRegistration()

XiAB = ar(A, B)

plt.plot(XiAB[<span class=hljs-number >0</span>].detach())

plt.plot((torch.arccos((x + <span class=hljs-number >.07</span> * torch.sin(<span class=hljs-number >3</span> * torch.pi * x))) * <span class=hljs-number >2</span> / torch.pi)[<span class=hljs-number >0</span>, <span class=hljs-number >0</span>])</code></pre> <img src="/assets/Reports/Sep142023/code/Xi.png" alt=""> <p>Our neural network produces the map which we proved registers A to B.</p> <h1 id=next_steps_apply_this_architecture_to_medical_images ><a href="#next_steps_apply_this_architecture_to_medical_images" class=header-anchor >Next steps: apply this architecture to medical images</a></h1> <h1 id=icon_manuscript_changelog ><a href="#icon_manuscript_changelog" class=header-anchor >ICON manuscript changelog</a></h1> <a href=/Reports/>Back to Reports</a> <div class=page-foot > <div> <a href=https://subdavis.com>subdavis.com </a> <a href=http://forrestli.con>forrestli.com</a> <div class=copyright > &copy; Hastings Greer. Last modified: August 09, 2024. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div>