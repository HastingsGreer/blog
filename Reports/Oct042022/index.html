<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="https://apj.hgreer.com/blog"> <link rel=icon  href="/assets/favicon.png"> <title>By Construction ICON, progressive training vs ent to end</title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <!-- <li><a href="/FeatureMapICON/">Feature Map Inverse Consistency</a> --> <li><a href="/HatTile/">Aperiodic Tiling with Z3</a> <!-- <li><a href="/ICON/">Inverse Consistent Regstration</a> <li><a href="/Mandelbrot/">Mandelbrot Set Adventures</a> --> <li><a href="/JavascriptMandelbrot/">Mandelbrot Set</a> <li><a href="/TrebuchetSimulator/">Trebuchet Simulator</a> <li><a href="/BadMatrixMultiply/">Bad Matrix Multiplication</a> <li><a href="/GameJam/">Game Jam Games</a> <li><a href="/menu3/">Tags</a> </ul> </div> <div id=main > <div class=franklin-content ><h1 id=by_construction_icon ><a href="#by_construction_icon" class=header-anchor >By Construction ICON</a></h1> <p>if we build an network that is inverse consistent by construction, then penalize it with the ICON error, how regularized is it? Does it become regularized by adding in noise?</p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.2500em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mi>v</mi><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msubsup><mi>N</mi><mi>θ</mi><mrow><mi>A</mi><mi>B</mi></mrow></msubsup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo><mo>−</mo><msubsup><mi>N</mi><mi>θ</mi><mrow><mi>B</mi><mi>A</mi></mrow></msubsup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mfrac><mi mathvariant=normal >∂</mi><mrow><mi mathvariant=normal >∂</mi><mi>t</mi></mrow></mfrac><msup><mi mathvariant=normal >Φ</mi><mrow><mi>A</mi><mi>B</mi></mrow></msup><mo stretchy=false >(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator=true >,</mo><mi>t</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mi>v</mi><mo stretchy=false >(</mo><msup><mi mathvariant=normal >Φ</mi><mrow><mi>A</mi><mi>B</mi></mrow></msup><mo stretchy=false >(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator=true >,</mo><mi>t</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msup><mi mathvariant=normal >Φ</mi><mrow><mi>A</mi><mi>B</mi></mrow></msup><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >,</mo><mn>0</mn><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><msup><mi mathvariant=normal >Φ</mi><mrow><mi>A</mi><mi>B</mi></mrow></msup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><msup><mi mathvariant=normal >Φ</mi><mrow><mi>A</mi><mi>B</mi></mrow></msup><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} v(x) &amp;= N_\theta^{AB}(x) - N_\theta^{BA}(x) \\ \frac{\partial}{\partial t} \Phi^{AB}(x_0, t) &amp;= v(\Phi^{AB}(x_0, t))\\ \Phi^{AB}(x, 0) &amp;= x \\ \Phi^{AB}(x) &amp;= \Phi^{AB}(x, 1) \end{aligned}</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:7.011433em;vertical-align:-3.2557165em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.7557165em;"><span style="top:-6.2358255em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span><span style="top:-4.2043855em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class=mord  style="margin-right:0.05556em;">∂</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mord ><span class=mord >Φ</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class=mclose >)</span></span></span><span style="top:-2.3270545000000005em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ><span class=mord >Φ</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >0</span><span class=mclose >)</span></span></span><span style="top:-0.7757234999999998em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ><span class=mord >Φ</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.2557165em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.7557165em;"><span style="top:-6.2358255em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.247em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.247em;"><span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span><span style="top:-4.2043855em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class=mopen >(</span><span class=mord ><span class=mord >Φ</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class=mord ><span class="mord mathnormal">x</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">t</span><span class=mclose >))</span></span></span><span style="top:-2.3270545000000005em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">x</span></span></span><span style="top:-0.7757234999999998em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord ><span class=mord >Φ</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >)</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.2557165em;"><span></span></span></span></span></span></span></span></span></span></span></span> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow></mrow><annotation encoding="application/x-tex"> </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ></span></span></span> <p><a href="https://colab.research.google.com/drive/1fPt6R3ZkbMJ_ntQHUkbQElhjQm9Z7Wax?usp&#61;sharing">notebook for byconstructionICON</a></p> <p>results depend heavily on loss</p> <p>Blurred SSD ConstICON</p> <img src="/assets/Reports/Oct042022/code/blurredssd.png" alt=""> <p>Blurred SSD NoReg</p> <img src="/assets/Reports/Oct042022/code/blurredssdnoreg.png" alt=""> <p>SSD ConstICON</p> <img src="/assets/Reports/Oct042022/code/ssdconsticon.png.png" alt=""> <p>SSD&#95;only&#95;interpolated&#95;consticon</p> <img src="/assets/Reports/Oct042022/code/ssd_only_interpolated_consticon.png" alt=""> <h1 id=simplified_progressive_train_pipeline ><a href="#simplified_progressive_train_pipeline" class=header-anchor >Simplified progressive train pipeline</a></h1> <p>Train the classic </p> <pre><code class="julia hljs">inner_net = icon.FunctionFromVectorField(networks.tallUNet2(dimension=<span class=hljs-number >3</span>))

<span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> range(<span class=hljs-number >2</span>):
    inner_net = icon.TwoStepRegistration(
        icon.DownsampleRegistration(inner_net, dimension=<span class=hljs-number >3</span>),
        icon.FunctionFromVectorField(networks.tallUNet2(dimension=<span class=hljs-number >3</span>))
    )</code></pre> <p>network end to end, then tack on an extra step at the final resolution.</p> <p><a href="https://github.com/uncbiag/ICON/blob/brain_evaluation/training_scripts/gradICON/preprocess_train_halfres_knees.py">Preprocessing data</a></p> <p><a href="https://github.com/uncbiag/ICON/blob/brain_evaluation/training_scripts/gradICON/gradicon_knee_halfres_new.py">End to end train most of it</a></p> <p><a href="https://github.com/uncbiag/ICON/blob/brain_evaluation/training_scripts/gradICON/gradicon_knee_halfres_new_2ndhalfres.py">Tack on one more layer</a></p> <pre><code class="julia hljs">inner_net = icon.FunctionFromVectorField(networks.tallUNet2(dimension=<span class=hljs-number >3</span>))

<span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> range(<span class=hljs-number >2</span>):
    inner_net = icon.twostepregistration(
        icon.downsampleregistration(inner_net, dimension=<span class=hljs-number >3</span>),
        icon.functionfromvectorfield(networks.tallunet2(dimension=<span class=hljs-number >3</span>))
    )
inner_net = icon.twostepregistration(
    inner_net, icon.functionfromvectorfield(networks.tallunet2(dimension=<span class=hljs-number >3</span>))
)</code></pre> <p>this second step is trained using only half res gradicon but the same accurate finite differences</p> <img src="/assets/Reports/Oct042022/code/loss_knee_2.png" alt=""> <p>performance:</p> <pre><code class="julia hljs">dice: tensor(<span class=hljs-number >0.7089</span>)
mean folds: <span class=hljs-number >0.17333333333333334</span></code></pre> <p>calculation <a href="https://github.com/uncbiag/icon/blob/brain_evaluation/notebooks/gradicon_add_second_halfres_dice.ipynb">notebook</a></p> <h1 id=paper_work ><a href="#paper_work" class=header-anchor >Paper work:</a></h1> <p>Convergence argument: I don&#39;t think that the o</p> <p>Tag on: for both end to end and progressive, tag on fine tuning</p> <p>Add a few sentences explaining that large channel counts at low resolution are basically free.</p> <p>immediate todo: put sparse into master</p> <p>Marc&#39;s paper that he is curious about</p> <p>https://www.sciencedirect.com/science/article/pii/S1361841522000858</p> <p>Mattias Heinrich&#39;s paper contains ANT, elastix lung results</p> <p>how does it do so good?</p> <a href=/Reports/>Back to Reports</a> <div class=page-foot > <div> <a href=https://subdavis.com>subdavis.com </a> <a href=http://forrestli.con>forrestli.com</a> <div class=copyright > &copy; Hastings Greer. Last modified: April 07, 2025. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div>