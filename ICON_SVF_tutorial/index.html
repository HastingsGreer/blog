<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=icon  href="/assets/favicon.png"> <title>How to write your own registration model</title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <!-- <li><a href="/FeatureMapICON/">Feature Map Inverse Consistency</a> --> <li><a href="/ICON/">Inverse Consistent Regstration</a> <li><a href="/Mandelbrot/">Mandelbrot Set Adventures</a> <li><a href="/BadMatrixMultiply/">Bad Matrix Multiplication</a> <li><a href="/GameJam/">Game Jam Games</a> <li><a href="/menu3/">Tags</a> </ul> </div> <div id=main > <div class=franklin-content ><h1 id=how_to_write_your_own_registration_model ><a href="#how_to_write_your_own_registration_model" class=header-anchor >How to write your own registration model</a></h1> <p>This document explains how to write a novel registration method in the ICON framework. </p> <h2 id=writing_a_similarity_measure ><a href="#writing_a_similarity_measure" class=header-anchor >Writing a similarity measure</a></h2> <p>Similarity measures in <code>icon_registration</code> are python functions that take two pytorch tensors representing batches of images. These pytorch channels have two channels: the first channel is image intensity.</p> <p>The second channel is 1 if the intensity at that voxel is interpolated, or zero otherwise. For some types of images, it is useful to disregard image similarity in extrapolated regions of a warped image. For images with a black background such as skull-stripped brains, this is not necessary.</p> <p>We will implement a simple ssd similarity:</p> <pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">ssd_similarity</span>(<span class=hljs-params >image_A, image_B</span>):
	<span class=hljs-comment ># since we are not using the interpolation information, we strip it off before computing similarity.</span>
	image_A, image_B = image_A[:, <span class=hljs-number >0</span>], image_B[:, <span class=hljs-number >0</span>]

	<span class=hljs-keyword >return</span> torch.mean((image_A - image_B)**<span class=hljs-number >2</span>)</code></pre> <h2 id=writing_a_registration_method ><a href="#writing_a_registration_method" class=header-anchor >Writing a registration method</a></h2> <p>In order to write a registration method, we first have to understand how <code>icon_registration</code> represents a transform. In <code>icon_registration</code>, a transform is any python function that takes as input a tensor of coordinates, and returns those coordinates transformed. </p> <p>This is intended to closely conform to the mathematical notion of a transform: a function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi><mo>:</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup><mo>→</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\phi: \mathbb{R}^N \rightarrow \mathbb{R}^N</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">ϕ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8413309999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.8413309999999999em;vertical-align:0em;"></span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span></p> <p>This is an extremely flexible definition, since the transform controls how its internal parameters are used to warp coordinates. On the flip side, it means that transforms are responsible for knowing how to interpret their parameters.</p> <p>The convention in icon is to store the parameters of the transform in the closure of the function; however an object oriented approach can also work. We will cover both options in this tutorial.</p> <p>Now that we know how a transform is represented, we can define a registration method: A registration method is simply any torch module that takes two images as input to its <code>forward</code> method and returns a transform.</p> <p>The registration methods available in <code>icon_registration</code> are defined in <code>icon_registration.network_wrappers.</code> </p> <p>They are named like &quot;FunctionFromMatrix&quot; or &quot;FunctionFromVectorField&quot; because they wrap an internal pytorch module that produces, for example, a matrix, from two images, and turn that matrix into a transform, ie a function.</p> <p>So&#33; Let us write a toy, euler integration based SVF registration.</p> <p>Registration methods in <code>icon_registration</code> are subclasses of torch.nn.Module with the following api: The forward method of a registration method take in two tensors representing batches of images, <code>image_A</code> and <code>image_B</code>, and returns a python function.</p> <p>This corresponds to a mathematical notion of a registration method as an operator from a pair of images to a function: </p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mrow><mi mathvariant=normal >Φ</mi><mo>:</mo><mo stretchy=false >(</mo><mo stretchy=false >(</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup><mo>→</mo><mi mathvariant=double-struck >R</mi><mo stretchy=false >)</mo><mo>×</mo><mo stretchy=false >(</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup><mo>→</mo><mi mathvariant=double-struck >R</mi><mo stretchy=false >)</mo><mo stretchy=false >)</mo><mo>→</mo><mo stretchy=false >(</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup><mo>→</mo><msup><mi mathvariant=double-struck >R</mi><mi>N</mi></msup><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex"> \Phi: (( \mathbb{R}^N \rightarrow \mathbb{R}) \times (\mathbb{R}^N \rightarrow \mathbb{R})) \rightarrow (\mathbb{R}^N \rightarrow \mathbb{R}^N) </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.68333em;vertical-align:0em;"></span><span class=mord >Φ</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class=mopen >((</span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">R</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >×</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span></span><span class=base ><span class=strut  style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathbb">R</span><span class=mclose >))</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class=mopen >(</span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathbb">R</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span><span class=mclose >)</span></span></span></span></span> <p>When we construct our FunctionFromStationaryVelocityField object, we will pass in a pytorch module net that is responsible for generating the velocity field from the input images. This way, it is easy experiment with different architectures.</p> <h3 id=object_oriented_stationary_velocity_field ><a href="#object_oriented_stationary_velocity_field" class=header-anchor >Object oriented stationary velocity field</a></h3> <pre><code class="julia hljs">class SVFTransform:
	def __init__(self, velocity_field, spacing, n_steps=<span class=hljs-number >16</span>):
		self.n_steps = n_steps
		self.spacing = spacing
		self.velocity_delta = velocity_field / n_steps
	def __call__(self, coordinate_tensor):
		<span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> range(<span class=hljs-number >16</span>):
			coordinate_tensor = coordinate_tensor + compute_warped_image_multiNC(
				self.velocity_delta, coordinate_tensor, self.spacing, <span class=hljs-number >1</span>)
		<span class=hljs-keyword >return</span> coordinate_tensor

class FunctionFromStationaryVelocityField(torch.nn.<span class=hljs-built_in >Module</span>):
	def __init__(self, net, n_steps=<span class=hljs-number >16</span>):
		super(FunctionFromStationaryVelocityField, self).__init__()
		self.net = net
		self.n_steps = n_steps

	def forward(self, x, y):
		velocity_field = self.net(x, y)
		<span class=hljs-keyword >return</span> SVFTransform(velocity_field, self.spacing, self.n_steps)</code></pre> <h3 id=closure_based_stationary_velocity_field ><a href="#closure_based_stationary_velocity_field" class=header-anchor >Closure based stationary velocity field</a></h3> <pre><code class="julia hljs">class FunctionFromStationaryVelocityField(torch.nn.<span class=hljs-built_in >Module</span>):
    def __init__(self, net, n_steps=<span class=hljs-number >16</span>):
        super(FunctionFromStationaryVelocityField, self).__init__()
        self.net = net

    def forward(self, x, y):
        velocityfield_delta = self.net(x, y) / self.n_steps
        def transform(coordinate_tensor):
            <span class=hljs-keyword >for</span> _ <span class=hljs-keyword >in</span> range(self.n_steps):
              coordinate_tensor = input_ + compute_warped_image_multiNC( 
                velocityfield_delta, coordinate_tensor, self.spacing, <span class=hljs-number >1</span>)
            <span class=hljs-keyword >return</span> coordinate_tensor
        <span class=hljs-keyword >return</span> transform</code></pre> <p>I strongly prefer the latter stylistically, but the two are interchangeable.</p> <div class=page-foot > <div> <a href=https://subdavis.com>subdavis.com </a> <a href=http://forrestli.con>forrestli.com</a> <div class=copyright > &copy; Hastings Greer. Last modified: August 24, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div>