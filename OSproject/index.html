<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=stylesheet  href="https://apj.hgreer.com/blog"> <link rel=icon  href="/assets/favicon.png"> <title></title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <!-- <li><a href="/FeatureMapICON/">Feature Map Inverse Consistency</a> --> <li><a href="/HatTile/">Aperiodic Tiling with Z3</a> <!-- <li><a href="/ICON/">Inverse Consistent Regstration</a> <li><a href="/Mandelbrot/">Mandelbrot Set Adventures</a> --> <li><a href="/JavascriptMandelbrot/">Mandelbrot Set</a> <li><a href="/TrebuchetSimulator/">Trebuchet Simulator</a> <li><a href="/BadMatrixMultiply/">Bad Matrix Multiplication</a> <li><a href="/GameJam/">Game Jam Games</a> <li><a href="/menu3/">Tags</a> </ul> </div> <div id=main > <div class=franklin-content ><p>There are various memory allocators and memory management strategies floating around</p> <p>Goal: make a memory allocator where the primary metric is that it should be easy to reason about for the compiler. Easy to reason about encourages inlining, inlining encourages vectorization</p> <p>We go so far as to</p> <p>&#40;Why float**? want compiler to track alignment&#41;</p> <pre><code class="julia hljs">typedef float** allocator;

float* alloc(allocator s, unsigned int size_floats) {
     *s = *s - size_floats;
     <span class=hljs-keyword >return</span> *s
}</code></pre> <p>Then, instead of paying the price of allocating while we are allocating, we build scaffolding using operating system and hardware features to make the above safe.</p> <p>First, how do we free memory? Never free, just discard allocators</p> <pre><code class="julia hljs"><span class=hljs-comment >#define allocator_push( old_allocator, new_allocator ) \</span>
float * stack_allocator_storage = * old_allocator; \
allocator new_allocator = &amp;stack_allocator_storage;</code></pre> <p>How do we expand memory? Never expand memory, always initially allocate memory the size of physical memory. Now, getting new memory is the responsibility of the operating system- compiler doesn&#39;t know about it.</p> <p>Now our enemy is the OOM killer: malloc failing was friendly and catchable, the oom killer is mysterious and will start wrecking things </p> <div class=page-foot > <div> <a href=https://subdavis.com>subdavis.com </a> <a href=http://forrestli.con>forrestli.com</a> <div class=copyright > &copy; Hastings Greer. Last modified: February 25, 2025. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div>